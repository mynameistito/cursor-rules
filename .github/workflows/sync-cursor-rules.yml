name: Sync Cursor Rules (Bulletproof)

on:
  push:
    branches:
      - main
    # paths:
    # - '.cursor/rules/**'
    # - '.cursor/commands/**'
    # - '.cursor/worktrees.json'
  workflow_dispatch:

jobs:
  sync-configuration:
    name: Sync ‚ûî ${{ matrix.repo }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: 
          - 'mynameistito/cursor-rules-test-1'
          - 'mynameistito/cursor-rules-test-2'

    steps:
      - name: üì• Checkout Source
        uses: actions/checkout@v4
        with:
          path: source_repo

      - name: üéØ Checkout Target
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          token: ${{ secrets.GH_PAT_SYNC }}
          path: target_repo
          fetch-depth: 0 # Required to detect branches

      - name: ‚öôÔ∏è Detect Default Branch
        working-directory: target_repo
        id: branch_info
        run: |
          # Detect the default branch (main, master, trunk, etc.)
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          echo "Detected default branch: $DEFAULT_BRANCH"
          echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          
          # Checkout that branch explicitly
          git checkout $DEFAULT_BRANCH

      - name: üîÑ Sync Files (Verbose)
        run: |
          echo "=============================================="
          echo "üöÄ SYNCING TO: ${{ matrix.repo }}"
          echo "=============================================="
          
          mkdir -p target_repo/.cursor

          # --- SYNC RULES ---
          echo ""
          echo "üìÇ SYNCING RULES..."
          rm -rf target_repo/.cursor/rules
          if [ -d "source_repo/.cursor/rules" ]; then
            cp -rv source_repo/.cursor/rules target_repo/.cursor/
          else
            echo "‚ö†Ô∏è Source has no 'rules' folder. Skipping."
          fi

          # --- SYNC COMMANDS ---
          echo ""
          echo "üìÇ SYNCING COMMANDS..."
          rm -rf target_repo/.cursor/commands
          if [ -d "source_repo/.cursor/commands" ]; then
            cp -rv source_repo/.cursor/commands target_repo/.cursor/
          else
            echo "‚ö†Ô∏è Source has no 'commands' folder. Skipping."
          fi

          # --- SYNC WORKTREES CONFIG ---
          echo ""
          echo "üìÑ SYNCING CONFIG..."
          if [ -f "source_repo/.cursor/worktrees.json" ]; then
             cp -v source_repo/.cursor/worktrees.json target_repo/.cursor/worktrees.json
          fi

      - name: üíæ Review & Push
        working-directory: target_repo
        run: |
          TARGET_BRANCH=${{ steps.branch_info.outputs.branch }}
          
          echo ""
          echo "=============================================="
          echo "üìä GIT STATUS ($TARGET_BRANCH)"
          echo "=============================================="
          
          git config user.name "Cursor-Sync-Bot"
          git config user.email "bot@cursor-rules.com"
          
          git add .cursor
          
          STATUS=$(git status -s)
          
          if [[ -n "$STATUS" ]]; then
            echo "üìù DETECTED CHANGES:"
            echo "$STATUS"
            echo ""
            
            # Use [skip ci] so this update doesn't trigger 
            # heavy build pipelines in the private repo.
            git commit -m "chore(cursor): sync shared rules from source [skip ci]"
            
            echo "üîÑ Pulling latest changes to prevent conflicts..."
            git pull --rebase origin $TARGET_BRANCH
            
            echo "üöÄ Pushing changes to '$TARGET_BRANCH'..."
            if git push origin $TARGET_BRANCH; then
              echo "‚úÖ SUCCESS: ${{ matrix.repo }} updated."
            else
              echo "‚ùå FAILURE: Could not push to ${{ matrix.repo }}."
              exit 1
            fi
          else
            echo "‚ú® NO CHANGES: Already up to date."
          fi
