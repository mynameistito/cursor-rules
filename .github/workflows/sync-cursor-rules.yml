name: "Sync Cursor Rules (Test Mode: Always Ping)"

on:
  push:
    branches:
      - main
    # paths:
    #   - '.cursor/rules/**'
  workflow_dispatch:

jobs:
  # ------------------------------------------------------------------
  # JOB 1: THE WORKER
  # ------------------------------------------------------------------
  sync-configuration:
    name: Sync ‚ûî ${{ matrix.repo }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: 
          # Personal
          - 'mynameistito/cursor-rules-test-1'
          - 'mynameistito/cursor-rules-test-2'
          
          # KillzoneGaming
          - 'KillzoneGaming/kzg-servers-connect'
          - 'KillzoneGaming/kzg-workshop-map-puller'
          - 'KillzoneGaming/kzg-website-nextjs'
          - 'KillzoneGaming/kzg-discord-oidc-worker'

    steps:
      - name: üì• Checkout Source
        uses: actions/checkout@v4
        with:
          path: source_repo

      - name: üéØ Checkout Target
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          token: ${{ secrets.GH_PAT_SYNC }}
          path: target_repo
          fetch-depth: 0 

      - name: ‚öôÔ∏è Detect Default Branch
        working-directory: target_repo
        id: branch_info
        run: |
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          git checkout $DEFAULT_BRANCH

      - name: üîÑ Sync Files
        run: |
          echo "üöÄ SYNCING TO: ${{ matrix.repo }}"
          mkdir -p target_repo/.cursor

          rm -rf target_repo/.cursor/rules
          if [ -d "source_repo/.cursor/rules" ]; then
            cp -rv source_repo/.cursor/rules target_repo/.cursor/
          fi

          rm -rf target_repo/.cursor/commands
          if [ -d "source_repo/.cursor/commands" ]; then
            cp -rv source_repo/.cursor/commands target_repo/.cursor/
          fi

          if [ -f "source_repo/.cursor/worktrees.json" ]; then
             cp -v source_repo/.cursor/worktrees.json target_repo/.cursor/worktrees.json
          fi

      - name: üíæ Review & Push
        working-directory: target_repo
        run: |
          TARGET_BRANCH=${{ steps.branch_info.outputs.branch }}
          git config user.name "mynameistito"
          git config user.email "github@mynameistito.com"
          git add .cursor
          
          STATUS=$(git status -s)
          if [[ -n "$STATUS" ]]; then
            git commit -m "chore(cursor): sync shared rules from source [skip ci]"
            git pull --rebase origin $TARGET_BRANCH
            git push origin $TARGET_BRANCH
          else
            echo "‚ú® NO CHANGES"
          fi

      - name: Report Failure
        if: failure()
        run: |
          SAFE_NAME=$(echo "${{ matrix.repo }}" | tr '/' '-')
          echo "${{ matrix.repo }}" > "failed_$SAFE_NAME.txt"

      - name: Upload Artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-${{ strategy.job-index }}
          path: failed_*.txt
          retention-days: 1

  # ------------------------------------------------------------------
  # JOB 2: THE REPORTER (Always Runs + Always Pings)
  # ------------------------------------------------------------------
  notify-discord:
    needs: sync-configuration
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: üì• Download Failure Reports
        uses: actions/download-artifact@v4
        with:
          pattern: failure-*
          merge-multiple: true
          path: failures

      - name: üö® Check Status & Ping
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # CHECK IF FAILURES EXIST
          if [ -d "failures" ] && [ "$(ls -A failures)" ]; then
            # --- FAILURE MODE (Red) ---
            echo "‚ùå Failures detected."
            
            LIST_STRING=""
            for f in failures/*.txt; do
              REPO_NAME=$(cat "$f")
              LIST_STRING="$LIST_STRING\\n- \`$REPO_NAME\`"
            done

            # ‚ö†Ô∏è CHANGE USER ID HERE IF NEEDED
            MESSAGE_CONTENT="‚ö†Ô∏è <@611746802122620937> **Sync Failed!** Issues detected."
            EMBED_DESC="$LIST_STRING"
            COLOR=15548997 # Red
          
          else
            # --- SUCCESS MODE (Green) ---
            echo "‚úÖ Success. Sending test ping."
            
            MESSAGE_CONTENT="‚úÖ <@611746802122620937> **Test Notification:** Sync Complete!"
            EMBED_DESC="All repositories were checked and are 100% in sync."
            COLOR=5763719 # Green
          fi

          # SEND PAYLOAD
          cat <<EOF > discord_payload.json
          {
            "username": "Cursor Sync Bot",
            "content": "$MESSAGE_CONTENT",
            "embeds": [
              {
                "description": "$EMBED_DESC",
                "color": $COLOR,
                "fields": [
                  {
                    "name": "View Logs",
                    "value": "[üëâ Click here]($LOG_URL)"
                  }
                ]
              }
            ]
          }
          EOF

          curl -H "Content-Type: application/json" -X POST -d @discord_payload.json "$DISCORD_WEBHOOK"